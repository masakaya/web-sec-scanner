# Prefect ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

ã“ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ã€ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«ã¨ã—ã¦ **Prefect** ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™ã€‚

## ğŸ“‹ æ¦‚è¦

Prefectã¯ã€Pythonã§ãƒ‡ãƒ¼ã‚¿ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚„ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’æ§‹ç¯‰ã€ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã€ç›£è¦–ã™ã‚‹ãŸã‚ã®æœ€æ–°ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚ªãƒ¼ã‚±ã‚¹ãƒˆãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚

### ä¸»ãªç‰¹å¾´

- âœ… **Pythonãƒã‚¤ãƒ†ã‚£ãƒ–**: ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚·ãƒ³ãƒ—ãƒ«ãªAPI
- âœ… **è¦³æ¸¬æ€§**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œã‚’ç›£è¦–
- âœ… **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ã€ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€ã‚¨ãƒ©ãƒ¼é€šçŸ¥
- âœ… **ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒªãƒ³ã‚°**: cronå½¢å¼ã‚„intervalå½¢å¼ã§ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ
- âœ… **ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰**: Webãƒ™ãƒ¼ã‚¹ã®ç®¡ç†UIã§å®Ÿè¡Œå±¥æ­´ã‚’ç¢ºèª

---

## ğŸš€ ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆ

### Prefectã‚µãƒ¼ãƒãƒ¼ã®èµ·å‹•

```bash
# Prefectã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ï¼ˆåˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§å®Ÿè¡Œï¼‰
# IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¯è‡ªå‹•æ¤œå‡ºã•ã‚Œã¾ã™
uv run poe prefect-server
```

èµ·å‹•æ™‚ã«ä»¥ä¸‹ã®ã‚ˆã†ãªæƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¾ã™:
```
ğŸš€ Starting Prefect server...
ğŸ“ Local access:    http://127.0.0.1:4200
ğŸŒ External access: http://192.168.1.14:4200
ğŸ”— API URL:         http://192.168.1.14:4200/api
```

> âš ï¸ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ³¨æ„**: `--host 0.0.0.0`ã§èµ·å‹•ã™ã‚‹ã¨å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚æœ¬ç•ªç’°å¢ƒã§ã¯é©åˆ‡ãªãƒ•ã‚¡ã‚¤ã‚¢ã‚¦ã‚©ãƒ¼ãƒ«è¨­å®šã‚„ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚

### ã‚µãƒ³ãƒ—ãƒ«ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œ

```bash
# ã‚µãƒ³ãƒ—ãƒ«ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ
uv run poe prefect-flow
```

---

## ğŸŒ å¤–éƒ¨ã‹ã‚‰ã®ã‚¢ã‚¯ã‚»ã‚¹è¨­å®š

### ã‚µãƒ¼ãƒãƒ¼å´ã®è¨­å®š

Prefectã‚µãƒ¼ãƒãƒ¼ã¯ `--host 0.0.0.0` ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§èµ·å‹•ã™ã‚‹ã“ã¨ã§ã€å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã«ãªã‚Šã¾ã™ã€‚

**IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¯è‡ªå‹•æ¤œå‡ºã•ã‚Œã¾ã™** - é€šå¸¸ã¯ä½•ã‚‚è¨­å®šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã›ã‚“:

```bash
# ã“ã‚Œã ã‘ã§OKï¼IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¯è‡ªå‹•æ¤œå‡ºã•ã‚Œã¾ã™
uv run poe prefect-server
```

èµ·å‹•æ™‚ã«è¡¨ç¤ºã•ã‚Œã‚‹å¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹URLã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãã ã‘ã§ã™ã€‚

#### æ‰‹å‹•ã§è¨­å®šã™ã‚‹å ´åˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰

ç‰¹å®šã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’ä½¿ã„ãŸã„å ´åˆã¯ã€ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã§ãã¾ã™:

```bash
export PREFECT_UI_API_URL="http://192.168.1.14:4200/api"
uv run poe prefect-server
```

### ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®è¨­å®š

å¤–éƒ¨ã®Prefectã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã™ã‚‹å ´åˆã€ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®šã—ã¾ã™:

```bash
# Prefect APIã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®š
export PREFECT_API_URL="http://<ã‚µãƒ¼ãƒãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹>:4200/api"

# è¨­å®šã‚’ç¢ºèª
prefect config view
```

ã¾ãŸã¯ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã”ã¨ã«è¨­å®šã™ã‚‹å ´åˆ:

```bash
# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’è¨­å®š
prefect config set PREFECT_API_URL="http://<ã‚µãƒ¼ãƒãƒ¼ã®IPã‚¢ãƒ‰ãƒ¬ã‚¹>:4200/api"
```

---

## ğŸ“š åŸºæœ¬çš„ãªä½¿ã„æ–¹

### ãƒ•ãƒ­ãƒ¼ã¨ã‚¿ã‚¹ã‚¯ã®å®šç¾©

Prefectã§ã¯ã€`@flow` ã¨ `@task` ãƒ‡ã‚³ãƒ¬ãƒ¼ã‚¿ã‚’ä½¿ã£ã¦ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®šç¾©ã—ã¾ã™ã€‚

```python
from prefect import flow, task

@task
def my_task(value: int) -> int:
    """ã‚¿ã‚¹ã‚¯ã®å®šç¾©"""
    return value * 2

@flow
def my_flow(numbers: list[int]) -> list[int]:
    """ãƒ•ãƒ­ãƒ¼ã®å®šç¾©"""
    results = []
    for num in numbers:
        result = my_task(num)
        results.append(result)
    return results

# å®Ÿè¡Œ
if __name__ == "__main__":
    my_flow([1, 2, 3, 4, 5])
```

### ã‚¿ã‚¹ã‚¯ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³

ã‚¿ã‚¹ã‚¯ã«ã¯æ§˜ã€…ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¨­å®šã§ãã¾ã™ï¼š

```python
@task(
    name="custom-task-name",
    description="ã‚¿ã‚¹ã‚¯ã®èª¬æ˜",
    retries=3,              # ãƒªãƒˆãƒ©ã‚¤å›æ•°
    retry_delay_seconds=60, # ãƒªãƒˆãƒ©ã‚¤é–“éš”ï¼ˆç§’ï¼‰
    timeout_seconds=300,    # ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆç§’ï¼‰
)
def my_task():
    pass
```

### ãƒ­ã‚°å‡ºåŠ›

Prefectã®ãƒ­ã‚¬ãƒ¼ã‚’ä½¿ç”¨ã—ã¦ãƒ­ã‚°ã‚’å‡ºåŠ›ã§ãã¾ã™ï¼š

```python
from prefect import task
from prefect.logging import get_run_logger

@task
def log_example():
    logger = get_run_logger()
    logger.info("æƒ…å ±ãƒ­ã‚°")
    logger.warning("è­¦å‘Šãƒ­ã‚°")
    logger.error("ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°")
```

---

## ğŸ”§ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå†…ã®ãƒ•ãƒ­ãƒ¼

### ã‚µãƒ³ãƒ—ãƒ«ãƒ•ãƒ­ãƒ¼

`src/example/example_flow.py` ã«ã‚µãƒ³ãƒ—ãƒ«ãƒ•ãƒ­ãƒ¼ãŒç”¨æ„ã•ã‚Œã¦ã„ã¾ã™ï¼š

```python
from src.example.example_flow import example_workflow

# ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œ
result = example_workflow(
    name="Your Name",
    numbers=[10, 20, 30]
)
```

---

## ğŸ› ï¸ åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰

### Prefecté–¢é€£ã‚¿ã‚¹ã‚¯

```bash
# Prefectã‚µãƒ¼ãƒãƒ¼èµ·å‹•ï¼ˆå¤–éƒ¨ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ï¼‰
uv run poe prefect-server

# ã‚µãƒ³ãƒ—ãƒ«ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œ
uv run poe prefect-flow

# ãƒ•ãƒ­ãƒ¼ã®ãƒ‡ãƒ—ãƒ­ã‚¤
uv run poe prefect-deploy
```

### ãã®ä»–ã®Prefect CLIã‚³ãƒãƒ³ãƒ‰

```bash
# ãƒ•ãƒ­ãƒ¼ä¸€è¦§è¡¨ç¤º
prefect flow ls

# ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆä¸€è¦§
prefect deployment ls

# ãƒ¯ãƒ¼ã‚«ãƒ¼ã®èµ·å‹•
prefect worker start --pool default

# å®Ÿè¡Œå±¥æ­´ã®ç¢ºèª
prefect flow-run ls
```

---

## ğŸ“– ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œ

ãƒ•ãƒ­ãƒ¼ã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«å®Ÿè¡Œã™ã‚‹ã«ã¯ã€ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ï¼š

### ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå®šç¾©ãƒ•ã‚¡ã‚¤ãƒ«

`prefect.yaml` ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã‚’å®šç¾©ï¼š

```yaml
deployments:
  - name: example-deployment
    entrypoint: src/example/example_flow.py:example_workflow
    schedule:
      cron: "0 9 * * *"  # æ¯æ—¥9æ™‚ã«å®Ÿè¡Œ
    work_pool:
      name: default
```

### ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆã®ä½œæˆ

```bash
# ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆä½œæˆ
prefect deploy --all

# ãƒ¯ãƒ¼ã‚«ãƒ¼èµ·å‹•ï¼ˆãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆå®Ÿè¡Œç”¨ï¼‰
prefect worker start --pool default
```

---

## ğŸ” ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã®ä½¿ã„æ–¹

Prefect UIãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ (http://127.0.0.1:4200) ã§ã¯ä»¥ä¸‹ã‚’ç¢ºèªã§ãã¾ã™ï¼š

- **Flow Runs**: ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œå±¥æ­´ã¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
- **Deployments**: ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆä¸€è¦§ã¨ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
- **Work Pools**: ãƒ¯ãƒ¼ã‚«ãƒ¼ãƒ—ãƒ¼ãƒ«ç®¡ç†
- **Blocks**: è¨­å®šã‚„ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ç®¡ç†

---

## ğŸ’¡ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. ã‚¿ã‚¹ã‚¯ã®ç²’åº¦

ã‚¿ã‚¹ã‚¯ã¯é©åˆ‡ãªç²’åº¦ã§åˆ†å‰²ã—ã¾ã—ã‚‡ã†ï¼š

```python
# âŒ ç²’åº¦ãŒå¤§ãã™ãã‚‹
@task
def do_everything():
    fetch_data()
    transform_data()
    save_data()

# âœ… é©åˆ‡ãªç²’åº¦
@task
def fetch_data():
    pass

@task
def transform_data():
    pass

@task
def save_data():
    pass
```

### 2. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

é‡è¦ãªã‚¿ã‚¹ã‚¯ã«ã¯é©åˆ‡ãªãƒªãƒˆãƒ©ã‚¤è¨­å®šã‚’ï¼š

```python
@task(retries=3, retry_delay_seconds=60)
def api_call():
    """å¤–éƒ¨APIå‘¼ã³å‡ºã—ãªã©ã€å¤±æ•—ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã‚¿ã‚¹ã‚¯"""
    pass
```

### 3. ãƒ­ã‚°ã®æ´»ç”¨

é©åˆ‡ãªãƒ­ã‚°ã‚’å‡ºåŠ›ã—ã¦ã€å®Ÿè¡ŒçŠ¶æ³ã‚’è¿½è·¡å¯èƒ½ã«ï¼š

```python
@task
def process_data(data):
    logger = get_run_logger()
    logger.info(f"Processing {len(data)} items")
    # å‡¦ç†...
    logger.info("Processing completed")
```

### 4. ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–

ãƒ•ãƒ­ãƒ¼ã¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒ–ã—ã¦å†åˆ©ç”¨å¯èƒ½ã«ï¼š

```python
@flow
def etl_flow(source: str, target: str, batch_size: int = 100):
    """ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§å‹•ä½œã‚’å¤‰æ›´å¯èƒ½ãªãƒ•ãƒ­ãƒ¼"""
    pass
```

---

## ğŸ“š å‚è€ƒãƒªãƒ³ã‚¯

- [Prefectå…¬å¼ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://docs.prefect.io/)
- [Prefect GitHub](https://github.com/PrefectHQ/prefect)
- [Prefect Concepts](https://docs.prefect.io/latest/concepts/)
- [Prefect Recipes](https://docs.prefect.io/latest/recipes/)

---

## ğŸ› ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚µãƒ¼ãƒãƒ¼ãŒèµ·å‹•ã—ãªã„

```bash
# Prefectã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ
prefect server database reset -y
```

### ãƒ•ãƒ­ãƒ¼ãŒå®Ÿè¡Œã•ã‚Œãªã„

```bash
# ãƒ¯ãƒ¼ã‚«ãƒ¼ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèª
prefect worker ls

# ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆãŒä½œæˆã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
prefect deployment ls
```

### ãƒ­ã‚°ãŒè¡¨ç¤ºã•ã‚Œãªã„

`get_run_logger()` ã‚’ä½¿ç”¨ã—ã¦Prefectã®ãƒ­ã‚¬ãƒ¼ã‹ã‚‰ãƒ­ã‚°ã‚’å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚æ¨™æº–ã® `print()` ã‚„ `logging` ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯æ¨å¥¨ã•ã‚Œã¾ã›ã‚“ã€‚
